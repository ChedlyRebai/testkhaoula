{% extends 'base.html.twig' %}

{% block title %}Mes T√¢ches{% endblock %}

{% block body %}
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow mb-4">
    <div class="container">
        <a class="navbar-brand" href="{{ path('app_home') }}">
            <img src="{{ asset('assets/images/logoes.png') }}" alt="EduSync" style="max-height: 40px; object-fit: contain;">
        {% extends 'front/base_edubin.html.twig' %}

        {% block title %}Tasks - EduSync{% endblock %}

        {% block body %}

            <!--====== PAGE HEADER PART START ======-->
    
            <section class="page-header-area" style="background-image: url({{ asset('edubin-images/slider/s-3.jpg') }})" data-overlay="4">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="page-header-cont">
                                <h1>Mes t√¢ches</h1>
                                <p class="text-white">G√©rez toutes vos t√¢ches efficacement</p>
                            </div>
                        </div>
                    </div> <!-- row -->
                </div> <!-- container -->
            </section>
    
            <!--====== PAGE HEADER PART ENDS ======-->

            <!--====== TASK LIST PART START ======-->
    
            <section class="pt-120 pb-120">
                <div class="container">
            
                    {% for message in app.flashes('success') %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert" style="margin-bottom: 30px;">
                            <i class="fa fa-check-circle"></i> {{ message }}
                            <button type="button" class="close" data-dismiss="alert">√ó</button>
                        </div>
                    {% endfor %}

                    <!-- SEARCH & FILTER BLOCKS -->
                    <div class="row mb-50">
                        <!-- SEARCH BLOCK (Left) -->
                        <div class="col-lg-6 pr-3 pr-lg-3">
                            <div class="search-block">
                                <div class="card shadow-lg" style="border-left: 5px solid #0066cc; height: 100%;">
                                    <div class="card-header bg-primary text-white" style="border-radius: 4px 4px 0 0;">
                                        <div class="d-flex align-items-center" style="gap: 10px;">
                                            <i class="fa fa-search fa-lg"></i>
                                            <h5 class="m-0">Rechercher</h5>
                                            <small class="ml-auto" style="font-size: 11px; opacity: 0.9;">üîó D√©pend des filtres</small>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-3">
                                            <i class="fa fa-info-circle"></i> Trouvez rapidement vos t√¢ches dans les r√©sultats filtr√©s
                                        </p>
                                        <div class="form-group mb-3">
                                            <label for="search-input" class="form-label"><strong>Mot-cl√©</strong></label>
                                            <div class="input-group input-group-lg">
                                                <input type="text" id="search-input" class="form-control" placeholder="Entrez le titre ou une partie de la description..." value="{{ search ?? '' }}" style="border-radius: 4px 0 0 4px;">
                                                <div class="input-group-append">
                                                    <button id="search-btn" class="btn btn-primary" type="button" style="border-radius: 0;">
                                                        <i class="fa fa-search"></i> Chercher
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <button id="search-clear-btn" class="btn btn-sm btn-outline-secondary w-100">
                                            <i class="fa fa-times"></i> Effacer la recherche
                                        </button>
                                        <div id="search-results-count" class="text-muted small mt-3 p-2" style="background: #f8f9fa; border-radius: 4px; border-left: 3px solid #0066cc;">
                                            {% if search %}
                                                <strong>üîó Recherche active :</strong> "{{ search }}"
                                            {% else %}
                                                <em>üîó Entrez un mot-cl√© pour affiner les r√©sultats filtr√©s...</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FILTER BLOCK (Right) -->
                        <div class="col-lg-6 pl-3 pl-lg-3">
                            <div class="filter-block">
                                <div class="card shadow-lg" style="border-left: 5px solid #17a2b8; height: 100%;">
                                    <div class="card-header bg-info text-white" style="border-radius: 4px 4px 0 0;">
                                        <div class="d-flex align-items-center" style="gap: 10px;">
                                            <i class="fa fa-sliders-h fa-lg"></i>
                                            <h5 class="m-0">Filtrer et Trier</h5>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-3">Organisez et triez les r√©sultats</p>
                                        <div class="form-group mb-2">
                                            <label for="filter-projet" class="form-label"><strong>Projet</strong></label>
                                            <select id="filter-projet" class="form-control form-control-sm">
                                                <option value="">üìã Tous les projets</option>
                                                {% for p in projets %}
                                                    <option value="{{ p.id }}" {% if projet and projet.id == p.id %}selected{% endif %}>
                                                        {{ p.nom }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label for="filter-statut" class="form-label"><strong>√âtat</strong></label>
                                            <select id="filter-statut" class="form-control form-control-sm">
                                                <option value="">‚úì Tous</option>
                                                <option value="√Ä faire" {% if statut == '√Ä faire' %}selected{% endif %}>üî¥ √Ä faire</option>
                                                <option value="En cours" {% if statut == 'En cours' %}selected{% endif %}>üü° En cours</option>
                                                <option value="Termin√©e" {% if statut == 'Termin√©e' %}selected{% endif %}>üü¢ Termin√©e</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label for="filter-priorite" class="form-label"><strong>Priorit√©</strong></label>
                                            <select id="filter-priorite" class="form-control form-control-sm">
                                                <option value="">‚úì Tous</option>
                                                <option value="1" {% if priorite == 1 %}selected{% endif %}>üü¢ Basse</option>
                                                <option value="2" {% if priorite == 2 %}selected{% endif %}>üü° Normale</option>
                                                <option value="3" {% if priorite == 3 %}selected{% endif %}>üî¥ Haute</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label for="sort-select" class="form-label"><strong>Trier par</strong></label>
                                            <select id="sort-select" class="form-control form-control-sm">
                                                <option value="date" {% if sort == 'date' %}selected{% endif %}>üìÖ Date</option>
                                                <option value="titre" {% if sort == 'titre' %}selected{% endif %}>üî§ Titre</option>
                                                <option value="statut" {% if sort == 'statut' %}selected{% endif %}>‚úì √âtat</option>
                                                <option value="priorite" {% if sort == 'priorite' %}selected{% endif %}>‚ö° Priorit√©</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label for="order-select" class="form-label"><strong>Ordre</strong></label>
                                            <select id="order-select" class="form-control form-control-sm">
                                                <option value="DESC" {% if order == 'DESC' %}selected{% endif %}>‚¨áÔ∏è D√©croissant</option>
                                                <option value="ASC" {% if order == 'ASC' %}selected{% endif %}>‚¨ÜÔ∏è Croissant</option>
                                            </select>
                                        </div>
                                        <button id="filter-reset-btn" class="btn btn-info text-white w-100 btn-sm">
                                            <i class="fa fa-redo"></i> R√©initialiser les filtres
                                        </button>
                                        <div id="filter-status" class="text-muted small mt-3 p-2" style="background: #f0f7ff; border-radius: 4px; border-left: 3px solid #17a2b8;">
                                            <strong>Filtres actifs :</strong><br>
                                            <span id="results-count">{{ taches|length }} r√©sultat(s)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Tasks Table -->
                    {% if taches is empty %}
                        <div class="alert alert-info text-center py-5">
                            <i class="fa fa-tasks fa-2x mb-3"></i>
                            <p>Aucune t√¢che trouv√©e.</p>
                            <a href="{{ path('tache_new') }}" class="main-btn mt-3">Cr√©er votre premi√®re t√¢che</a>
                        </div>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="taches-table-body">
                                <thead class="bg-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Titre</th>
                                        <th>Projet</th>
                                        <th>√âtat</th>
                                        <th>Priorit√©</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tache in taches %}
                                    <tr>
                                        <td><strong>#{{ tache.id }}</strong></td>
                                        <td>{{ tache.titre }}</td>
                                        <td>
                                            <a href="{{ path('tache_list', {'projet': tache.projet.id}) }}">
                                                {{ tache.projet.nom }}
                                            </a>
                                        </td>
                                        <td>
                                            {% if tache.statut == '√Ä faire' %}
                                                <span class="badge badge-secondary">√Ä faire</span>
                                            {% elseif tache.statut == 'En cours' %}
                                                <span class="badge badge-primary">En cours</span>
                                            {% elseif tache.statut == 'Termin√©e' %}
                                                <span class="badge badge-success">Termin√©e</span>
                                            {% else %}
                                                <span class="badge badge-warning">{{ tache.statut }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if tache.priorite == 1 %}
                                                <span class="badge badge-success">Basse</span>
                                            {% elseif tache.priorite == 2 %}
                                                <span class="badge badge-warning">Normale</span>
                                            {% elseif tache.priorite == 3 %}
                                                <span class="badge badge-danger">Haute</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ path('tache_show', {'id': tache.id}) }}" class="btn btn-sm btn-outline-primary">Voir</a>
                                            <a href="{{ path('tache_edit', {'id': tache.id}) }}" class="btn btn-sm btn-outline-warning">Modifier</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                
                        <div class="row mt-50">
                            <div class="col-lg-12 text-center">
                                <a href="{{ path('tache_new') }}" class="main-btn">Ajouter une nouvelle t√¢che</a>
                            </div>
                        </div>
                    {% endif %}

                </div> <!-- container -->
            </section>
    
            <!--====== TASK LIST PART ENDS ======-->

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const filterManager = new FilterManager({
                        apiUrl: '{{ path("tache_api_search") }}',
                        tableBodySelector: '#taches-table-body tbody',
                        searchInputId: 'search-input',
                        sortSelectId: 'sort-select',
                        orderSelectId: 'order-select',
                        filterSelectIds: ['filter-projet', 'filter-statut', 'filter-priorite'],
                        entityType: 'taches'
                    });

                    // Load filters from URL if present
                    const urlParams = new URLSearchParams(window.location.search);
                    const searchVal = urlParams.get('search');
                    const projetVal = urlParams.get('projet');
                    const statutVal = urlParams.get('statut');
                    const prioriteVal = urlParams.get('priorite');
                    const sortVal = urlParams.get('sort');
                    const orderVal = urlParams.get('order');

                    if (searchVal) {
                        document.getElementById('search-input').value = decodeURIComponent(searchVal);
                    }
                    if (projetVal) {
                        document.getElementById('filter-projet').value = decodeURIComponent(projetVal);
                    }
                    if (statutVal) {
                        document.getElementById('filter-statut').value = decodeURIComponent(statutVal);
                    }
                    if (prioriteVal) {
                        document.getElementById('filter-priorite').value = decodeURIComponent(prioriteVal);
                    }
                    if (sortVal) {
                        document.getElementById('sort-select').value = decodeURIComponent(sortVal);
                    }
                    if (orderVal) {
                        document.getElementById('order-select').value = decodeURIComponent(orderVal);
                    }

                    // If any filter is set in URL, trigger search
                    if (searchVal || projetVal || statutVal || prioriteVal || (sortVal && sortVal !== 'date') || (orderVal && orderVal !== 'DESC')) {
                        filterManager.performSearch();
                    }

                    // Reset button
                    const resetBtn = document.getElementById('reset-filters');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', function() {
                            document.getElementById('search-input').value = '';
                            document.getElementById('filter-projet').value = '';
                            document.getElementById('filter-statut').value = '';
                            document.getElementById('filter-priorite').value = '';
                            document.getElementById('sort-select').value = 'date';
                            document.getElementById('order-select').value = 'DESC';
                            filterManager.performSearch();
                        });
                    }
                });
            </script>

        {% endblock %}
